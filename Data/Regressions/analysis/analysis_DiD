import pandas as pd
import statsmodels.formula.api as smf
import os

# Create output folder if it doesn't exist
output_folder = "Data/Regressions/outputs"
os.makedirs(output_folder, exist_ok=True)

# Load your merged panel
df = pd.read_csv("Data/Panel/panel_country_year_2000_2021_with_bri_and_aiddata.csv")


# Choose outcome
outcome = "secondary_enroll_gross_pct"
controls = ["log_gdp_pc_current_usd", "population_total", "percent_urban"]

# Keep only rows where outcome exists
df_model = df.dropna(subset=[outcome]).copy()

# If you include controls, you must drop missing controls too
df_model = df_model.dropna(subset=controls + ["post_join", "Country Code", "year"]).copy()

# DiD with country FE + year FE, cluster SEs by country
formula = (
    f"{outcome} ~ post_join + "
    f"{' + '.join(controls)} + "
    "C(year) + C(Q('Country Code'))"
)

model = smf.ols(formula=formula, data=df_model).fit(
    cov_type="cluster",
    cov_kwds={"groups": df_model["Country Code"]}
)

# Write results to output file
output_file = os.path.join(output_folder, "regression_results.txt")
with open(output_file, "w") as f:
    f.write(model.summary().as_text())
    f.write("\n\nKey effect (post_join):\n")
    f.write(f"{model.params['post_join']} (SE: {model.bse['post_join']})\n")

print(f"Results saved to {output_file}")
